### 熔断
熔断就是当发现有一定数量的请求处于等待状态时，为了防止拖累前端服务，停止将后续的请求发给这个服务。

```yaml
cat > ratings-dr.yaml <<EOF
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ratings-dr
  namespace: bookinfo
spec:
  host: ratings
  trafficPolicy: # trafficPolicy 配置，可以配置在subsets级别
    connectionPool: # 连接池配置,可以单独使用限制程序的并发数
      tcp:
        maxConnections: 3 # 最大并发数为3，在部署程序时，提前确认程序可以承受的并发数。
      http:
        http1MaxPendingRequests: 1 # 最大的待处理请求
        maxRequestsPerConnection: 1 # 每个请求最大的链接数
    outlierDetection: # 熔断探测配置,可单独使用，不依赖connectionPool
      consecutive5xxErrors: 1 #如果连续出现的错误超过 1 次，就会被熔断
      interval: 10s # 每10秒探测一次后端实例
      baseEjectionTime: 3m # 熔断的时间
      maxEjectionPercent: 100 # 被熔断实例最大的百分比，根据实际情况设置
  subsets:
  - labels:
      version: v1
    name: v1
EOF
```

发送一个请求，可以看到当前状态码为200，即连接成功：  
```shell
kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -curl http://ratings:9080/ratings/0
```
```text
[root@master01 istio-1.13.0]# kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -curl http://ratings:9080/ratings/0
HTTP/1.1 200 OK
content-type: application/json
date: Sun, 13 Nov 2022 08:34:56 GMT
x-envoy-upstream-service-time: 23
server: envoy
transfer-encoding: chunked

30
{"id":0,"ratings":{"Reviewer1":5,"Reviewer2":4}}
0

[root@master01 istio-1.13.0]# 
```

部署熔断配置：  
```shell
kubectl apply -f ratings-dr.yaml
```

接下来更改为两个并发连接（-c 2），发送 20 请求（-n 20）：  
```shell
kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -c 20 -qps 0 -n 20 -loglevel Warning http://ratings:9080/ratings/0 | grep Code
```

最后可以查看fortio请求记录（upstream_rq_pending_overflow表示熔断的次数）：  
```shell
kubectl -n bookinfo exec -it $FORTIO_POD -c istio-proxy -- sh -c 'curl localhost:15000/stats' | grep ratings | grep pending_overflow
```