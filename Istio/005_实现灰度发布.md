首先将reviews的所有流量指向v1版本，此时需要通过DestinationRule将reviews分成三个版本：

```yaml
cat > reviews-dr.yaml <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-dr
  namespace: bookinfo
spec:
  host: reviews  # 匹配名字为 reviews 的 service, 根据svc发现所有的pod，然后根据下面的subnet发现不同版本的pod
  subsets:
  - name: v1
    labels:
      version: v1 # subset v1 指向具有标签 version=v1 的 Pod
  - name: v2
    labels:
      version: v2 # subset v1 指向具有标签 version=v2 的 Pod
  - name: v3
    labels:
      version: v3 # subset v1 指向具有标签 version=v3 的 Pod

EOF
kubectl apply -f reviews-dr.yaml
kubectl scale deploy reviews-v2 --replicas=1 -n bookinfo
kubectl scale deploy reviews-v3 --replicas=1 -n bookinfo
```

接下来配置VirtualService将所有流量指向reviews的v1版本：

```yaml
cat > reviews-v1-all.yaml <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
  namespace: bookinfo
spec:
  hosts:
  - reviews # 匹配名字为reviews的svc
  http:
  - route:
    - destination:
        host: reviews
        subset: v1 # 将所有流量指向 v1
EOF
# 创建该 VirtualService
kubectl apply -f reviews-v1-all.yaml
```
接下修改VirtualService，将20%的流量导向v2版本：
```yaml
cat > reviews-v2-20-vs.yaml <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
  namespace: bookinfo
spec:
  hosts:
  - reviews # 匹配名字为reviews的svc
  http:
  - route:
    - destination:
        host: reviews
        subset: v1 
      weight: 80
    - destination:
        host: reviews
        subset: v2 
      weight: 20      
EOF
# 创建该 VirtualService
kubectl apply -f reviews-v2-20-vs.yaml
```
假设V2版本没有问题，接下修改VirtualService，将所有的流量导向v2版本：
```yaml
cat > reviews-v2-all-vs.yaml <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews-vs
  namespace: bookinfo
spec:
  hosts:
  - reviews # 匹配名字为reviews的svc
  http:
  - route:
    - destination:
        host: reviews
        subset: v2 # 将所有流量指向 v2
   
EOF
# 创建该 VirtualService
kubectl apply -f reviews-v2-all-vs.yaml
```

#### 使用Kiali配置流量分配
使用Kiali配置流量分配比例需要先将上面配置的DR和VS删除。  
点击Services--->reviews--->Actions--->Traffic Shifting