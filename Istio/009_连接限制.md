### 连接限制
当一个服务处理请求时，请求数量超出处理能力，连接会出现中断或等待的问题，这时若继续将请求转发给这个服务，可能会导致这个服务出现更严重的故障。所以要配置连接数限制。  

### 熔断
熔断就是当发现有一定数量的请求处于等待状态时，为了防止拖累前端服务，停止将后续的请求发给这个服务。  

假设对ratings进行熔断，希望在并发请求数超过3，并且存在1个以上的待处理请求，就触发熔断，此时可以配置ratings的DestinationRule如下所示：

```yaml
cat > ratings-dr.yaml <<EOF
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ratings-dr
  namespace: bookinfo
spec:
  host: ratings
  trafficPolicy: # trafficPolicy 配置，可以配置在subsets级别
    connectionPool: # 连接池配置,可以单独使用限制程序的并发数
      tcp:
        maxConnections: 3 # 最大并发数为3，在部署程序时，提前确认程序可以承受的并发数。
      http:
        http1MaxPendingRequests: 1 # 最大的待处理请求
        maxRequestsPerConnection: 1 # 每个连接最大的请求数
EOF
```

保存退出后，先部署测试工具fortio，用于对容器业务进行压力测试：

```yaml
kubectl -n bookinfo apply -f samples/httpbin/sample-client/fortio-deploy.yaml
```

等待 fortio 容器启动后, 获取 fortio 容器 id:

```shell
FORTIO_POD=$(kubectl get pod -n bookinfo | grep fortio | awk '{ print $1 }')
echo $FORTIO_POD
```

发送一个请求，可以看到当前状态码为200，即连接成功：  
```shell
kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -curl http://ratings:9080/ratings/0
```
```text
[root@master01 istio-1.13.0]# kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -curl http://ratings:9080/ratings/0
HTTP/1.1 200 OK
content-type: application/json
date: Sun, 13 Nov 2022 08:34:56 GMT
x-envoy-upstream-service-time: 23
server: envoy
transfer-encoding: chunked

30
{"id":0,"ratings":{"Reviewer1":5,"Reviewer2":4}}
0

[root@master01 istio-1.13.0]# 
```

部署连接数配置：  
```shell
kubectl apply -f ratings-dr.yaml
```

接下来更改为两个并发连接（-c 2），发送 20 请求（-n 20）：  
```shell
kubectl exec -ti $FORTIO_POD -n bookinfo -- fortio load -c 20 -qps 0 -n 20 -loglevel Warning http://ratings:9080/ratings/0 | grep Code
```
